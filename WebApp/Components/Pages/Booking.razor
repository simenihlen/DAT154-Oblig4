@page "/booking"
@using HotelLibrary.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@attribute [Authorize(Roles = "admin, guest")]
@inject HotelDbContext dx
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Booking</PageTitle>

<h1>Book room</h1>

<h1>Her kan du booke room</h1>
<label>
    Kvalitet:
    <select @bind="valgRomKval">
        @foreach(var vk in roomQuality) {
            <option value="@vk.RoomQuality">@vk.RoomQuality</option>
        }
    </select>
</label><br/>
<lable>Start dato: <input type="date" @bind="startdate"/></lable><br />
<lable>Slutt dato: <input type="date" @bind="enddate"/></lable><br />
<label>Antall personer: <input type="number" @bind="antall"/></label><br />

<button @onclick="bookedRoom">Book rommet</button>

@if (booked) {
    <h2>Roomet er booket</h2>
}

@code {
    private string? valgRomKval;
    private List<Roomdatum> roomQuality = [];
    private DateTime startdate = DateTime.Now;
    private DateTime enddate = DateTime.Now.AddDays(1);
    private int antall = 1;
    private User? user;
    private bool booked;

    protected override async Task OnInitializedAsync() {
        var dx = new HotelDbContext();
        roomQuality = await dx.Roomdata.ToListAsync();
        user = await findUser();
    }

    private async Task<Roomdatum> getRoom() {
        var dx = new HotelDbContext();
        try {
            var room = new Roomdatum {
                RoomQuality = valgRomKval,
                NumberOfBeds = antall
            };
            Console.WriteLine("Rom med " + room.RoomQuality + " kvalitet og " + room.NumberOfBeds + " antall senger.");
            dx.Roomdata.Add(room);
            await dx.SaveChangesAsync();
            return room;
        } catch(Exception e) {

        }
        return null;
    }

    private async Task<string> getUserId() {
        var asp = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = asp.User;
        if (user.Identity.IsAuthenticated)
        {
            return user.FindFirstValue(ClaimTypes.NameIdentifier);
        }
        return null;
    }

    private async Task<User> findUser() {
        User local = null;
        try {
            var userId = await getUserId();
            local = await dx.Users.FirstOrDefaultAsync(u => u.Username == userId);
        } catch (Exception e) {

        }
        return local;
    }

    private async Task bookedRoom() {
        try {
            var room = await getRoom();

            var booking = new Bookingdatum {
                    Roomid = room.Id,
                    Userid = user.Id,
                    Startdate = startdate,
                    Enddate = enddate
            };
            dx.Bookingdata.Add(booking);
            await dx.SaveChangesAsync();
            booked = true;
        } catch (Exception e) {
            
        }
    }
}
